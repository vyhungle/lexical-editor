/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
"use strict";var e=require("@lexical/react/LexicalComposerContext"),t=require("@lexical/utils"),n=require("lexical"),r=require("react"),a=require("@lexical/react/useLexicalNodeSelection"),i=require("@excalidraw/excalidraw"),l=require("react-dom");function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},o.apply(this,arguments)}const s=r.lazy((()=>Promise.resolve().then((function(){return k}))));function c(e){const t=e.getAttribute("data-lexical-excalidraw-json");if(t){const e=d();return e.__data=t,{node:e}}return null}class u extends n.DecoratorNode{static getType(){return"excalidraw"}static clone(e){return new u(e.__data,e.__key)}static importJSON(e){return new u(e.data)}exportJSON(){return{data:this.__data,type:"excalidraw",version:1}}constructor(e="[]",t){super(t),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"__data",void 0),this.__data=e}createDOM(e){const t=document.createElement("span"),n=e.theme.image;return void 0!==n&&(t.className=`${n} editor-image`),t}updateDOM(){return!1}static importDOM(){return{span:e=>e.hasAttribute("data-lexical-excalidraw-json")?{conversion:c,priority:1}:null}}exportDOM(e){const t=document.createElement("span"),n=e.getElementByKey(this.getKey());if(null!==n){const e=n.querySelector("svg");null!==e&&(t.innerHTML=e.outerHTML)}return t.setAttribute("data-lexical-excalidraw-json",this.__data),{element:t}}setData(e){this.getWritable().__data=e}decorate(e,t){return r.createElement(r.Suspense,{fallback:null},r.createElement(s,{nodeKey:this.getKey(),data:this.__data}))}}function d(){return new u}function m(e){return e instanceof u}const E=n.createCommand("INSERT_EXCALIDRAW_COMMAND");function g(){const[a]=e.useLexicalComposerContext();return r.useEffect((()=>{if(!a.hasNodes([u]))throw new Error("ExcalidrawPlugin: ExcalidrawNode not registered on editor");return a.registerCommand(E,(()=>{const e=d();return n.$insertNodes([e]),n.$isRootOrShadowRoot(e.getParentOrThrow())&&t.$wrapNodeInElement(e,n.$createParagraphNode).selectEnd(),!0}),n.COMMAND_PRIORITY_EDITOR)}),[a]),null}const f=r.createContext(null);function h({children:e,className:t,onClick:n,title:a}){const i=r.useRef(null),l=r.useContext(f);if(null===l)throw new Error("DropDownItem must be used within a DropDown");const{registerItem:o}=l;return r.useEffect((()=>{i&&i.current&&o(i)}),[i,o]),r.createElement("button",{className:t,onClick:n,ref:i,title:a,type:"button"},e)}const p={name:"excalidraw",node:u,plugin:g,toolbarInsertAfter:function({activeEditor:e}){return r.createElement(h,{onClick:()=>{e.dispatchCommand(E,void 0)},className:"item"},r.createElement("i",{className:"icon diagram-2"}),r.createElement("span",{className:"text"},"Excalidraw"))}};function w(e,t,n){return Math.min(Math.max(e,t),n)}const y=1,b=8,v=2,C=4;function _({onResizeStart:e,onResizeEnd:t,buttonRef:n,imageRef:a,maxWidth:i,editor:l,showCaption:o,setShowCaption:s,captionsEnabled:c}){const u=r.useRef(null),d=r.useRef({priority:"",value:"default"}),m=r.useRef({currentHeight:0,currentWidth:0,direction:0,isResizing:!1,ratio:0,startHeight:0,startWidth:0,startX:0,startY:0}),E=l.getRootElement(),g=i||(null!==E?E.getBoundingClientRect().width-20:100),f=null!==E?E.getBoundingClientRect().height-20:100,h=(t,n)=>{if(!l.isEditable())return;const r=a.current,i=u.current;if(null!==r&&null!==i){const{width:a,height:l}=r.getBoundingClientRect(),o=m.current;o.startWidth=a,o.startHeight=l,o.ratio=a/l,o.currentWidth=a,o.currentHeight=l,o.startX=t.clientX,o.startY=t.clientY,o.isResizing=!0,o.direction=n,(e=>{const t=e===y||e===C?"ew":e===b||e===v?"ns":e&b&&e&C||e&v&&e&y?"nwse":"nesw";null!==E&&E.style.setProperty("cursor",`${t}-resize`,"important"),null!==document.body&&(document.body.style.setProperty("cursor",`${t}-resize`,"important"),d.current.value=document.body.style.getPropertyValue("-webkit-user-select"),d.current.priority=document.body.style.getPropertyPriority("-webkit-user-select"),document.body.style.setProperty("-webkit-user-select","none","important"))})(n),e(),i.classList.add("image-control-wrapper--resizing"),r.style.height=`${l}px`,r.style.width=`${a}px`,document.addEventListener("pointermove",p),document.addEventListener("pointerup",_)}},p=e=>{const t=a.current,n=m.current,r=n.direction&(y|C),i=n.direction&(v|b);if(null!==t&&n.isResizing)if(r&&i){let r=Math.floor(n.startX-e.clientX);r=n.direction&y?-r:r;const a=w(n.startWidth+r,100,g),i=a/n.ratio;t.style.width=`${a}px`,t.style.height=`${i}px`,n.currentHeight=i,n.currentWidth=a}else if(i){let r=Math.floor(n.startY-e.clientY);r=n.direction&v?-r:r;const a=w(n.startHeight+r,100,f);t.style.height=`${a}px`,n.currentHeight=a}else{let r=Math.floor(n.startX-e.clientX);r=n.direction&y?-r:r;const a=w(n.startWidth+r,100,g);t.style.width=`${a}px`,n.currentWidth=a}},_=()=>{const e=a.current,n=m.current,r=u.current;if(null!==e&&null!==r&&n.isResizing){const e=n.currentWidth,a=n.currentHeight;n.startWidth=0,n.startHeight=0,n.ratio=0,n.startX=0,n.startY=0,n.currentWidth=0,n.currentHeight=0,n.isResizing=!1,r.classList.remove("image-control-wrapper--resizing"),null!==E&&E.style.setProperty("cursor","default"),null!==document.body&&(document.body.style.setProperty("cursor","default"),document.body.style.setProperty("-webkit-user-select",d.current.value,d.current.priority)),t(e,a),document.removeEventListener("pointermove",p),document.removeEventListener("pointerup",_)}};return r.createElement("div",{ref:u},!o&&c&&r.createElement("button",{className:"image-caption-button",ref:n,onClick:()=>{s(!o)}},"Add Caption"),r.createElement("div",{className:"image-resizer image-resizer-n",onPointerDown:e=>{h(e,b)}}),r.createElement("div",{className:"image-resizer image-resizer-ne",onPointerDown:e=>{h(e,b|y)}}),r.createElement("div",{className:"image-resizer image-resizer-e",onPointerDown:e=>{h(e,y)}}),r.createElement("div",{className:"image-resizer image-resizer-se",onPointerDown:e=>{h(e,v|y)}}),r.createElement("div",{className:"image-resizer image-resizer-s",onPointerDown:e=>{h(e,v)}}),r.createElement("div",{className:"image-resizer image-resizer-sw",onPointerDown:e=>{h(e,v|C)}}),r.createElement("div",{className:"image-resizer image-resizer-w",onPointerDown:e=>{h(e,C)}}),r.createElement("div",{className:"image-resizer image-resizer-nw",onPointerDown:e=>{h(e,b|C)}}))}function N({elements:e,imageContainerRef:t,appState:n=null,rootClassName:a=null}){const[l,o]=r.useState(null);return r.useEffect((()=>{(async()=>{const t=await i.exportToSvg({elements:e,files:null});(e=>{const t=e?.firstElementChild?.firstElementChild,n=e.getAttribute("viewBox");if(null!=n){const t=n.split(" ");e.setAttribute("width",t[2]),e.setAttribute("height",t[3])}t&&"style"===t.tagName&&t.remove()})(t),t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("display","block"),o(t)})()}),[e,n]),r.createElement("div",{ref:t,className:a??"",dangerouslySetInnerHTML:{__html:l?.outerHTML??""}})}function x(...e){return e.filter(Boolean).join(" ")}function O({"data-test-id":e,children:t,className:n,onClick:a,disabled:i,small:l,title:s}){return r.createElement("button",o({disabled:i,className:x("Button__root",i&&"Button__disabled",l&&"Button__small",n),onClick:a,title:s,"aria-label":s},e&&{"data-test-id":e}),t)}function R({onClose:e,children:t,title:n,closeOnClickOutside:a}){const i=r.useRef(null);return r.useEffect((()=>{null!==i.current&&i.current.focus()}),[]),r.useEffect((()=>{let t=null;const n=t=>{27===t.keyCode&&e()},r=t=>{const n=t.target;null!==i.current&&!i.current.contains(n)&&a&&e()},l=i.current;return null!==l&&(t=l.parentElement,null!==t&&t.addEventListener("click",r)),window.addEventListener("keydown",n),()=>{window.removeEventListener("keydown",n),null!==t&&t?.removeEventListener("click",r)}}),[a,e]),r.createElement("div",{className:"Modal__overlay",role:"dialog"},r.createElement("div",{className:"Modal__modal",tabIndex:-1,ref:i},r.createElement("h2",{className:"Modal__title"},n),r.createElement("button",{className:"Modal__closeButton","aria-label":"Close modal",type:"button",onClick:e},"X"),r.createElement("div",{className:"Modal__content"},t)))}function M({onClose:e,children:t,title:n,closeOnClickOutside:a=!1}){return l.createPortal(r.createElement(R,{onClose:e,title:n,closeOnClickOutside:a},t),document.body)}function D({closeOnClickOutside:e=!1,onSave:t,initialElements:n,isShown:a=!1,onDelete:o}){const s=r.useRef(null),[c,u]=r.useState(!1),[d,m]=r.useState(n);r.useEffect((()=>{null!==s.current&&s.current.focus()}),[]),r.useEffect((()=>{let t=null;const n=t=>{const n=t.target;null!==s.current&&!s.current.contains(n)&&e&&o()};return null!==s.current&&(t=s.current?.parentElement,null!==t&&t?.addEventListener("click",n)),()=>{null!==t&&t?.removeEventListener("click",n)}}),[e,o]),r.useLayoutEffect((()=>{const e=s.current,t=e=>{"Escape"===e.key&&o()};return null!==e&&e.addEventListener("keydown",t),()=>{null!==e&&e.removeEventListener("keydown",t)}}),[d,o]);function E(){return r.createElement(M,{title:"Discard",onClose:()=>{u(!1)},closeOnClickOutside:!0},"Are you sure you want to discard the changes?",r.createElement("div",{className:"ExcalidrawModal__discardModal"},r.createElement(O,{onClick:()=>{u(!1),o()}},"Discard")," ",r.createElement(O,{onClick:()=>{u(!1)}},"Cancel")))}if(!1===a)return null;const g=null!=i.$$typeof?i:i.default;return l.createPortal(r.createElement("div",{className:"ExcalidrawModal__overlay",role:"dialog"},r.createElement("div",{className:"ExcalidrawModal__modal",ref:s,tabIndex:-1},r.createElement("div",{className:"ExcalidrawModal__row"},c&&r.createElement(E,null),r.createElement(g,{onChange:e=>{m(e)},initialData:{appState:{isLoading:!1},elements:n}}),r.createElement("div",{className:"ExcalidrawModal__actions"},r.createElement("button",{className:"action-button",onClick:()=>{0===d.filter((e=>!e.isDeleted)).length?o():u(!0)}},"Discard"),r.createElement("button",{className:"action-button",onClick:()=>{d.filter((e=>!e.isDeleted)).length>0?t(d):o()}},"Save"))))),document.body)}var k={__proto__:null,default:function({nodeKey:i,data:l}){const[o]=e.useLexicalComposerContext(),[s,c]=r.useState("[]"===l&&o.isEditable()),u=r.useRef(null),d=r.useRef(null),E=r.useRef(null),[g,f,h]=a.useLexicalNodeSelection(i),[p,w]=r.useState(!1),y=r.useCallback((e=>(g&&n.$isNodeSelection(n.$getSelection())&&(e.preventDefault(),o.update((()=>{const e=n.$getNodeByKey(i);m(e)&&e.remove(),f(!1)}))),!1)),[o,g,i,f]);r.useEffect((()=>{s?o.setEditable(!1):o.setEditable(!0)}),[s,o]),r.useEffect((()=>t.mergeRegister(o.registerCommand(n.CLICK_COMMAND,(e=>{const t=d.current,n=e.target;return!!p||!(null===t||!t.contains(n))&&(e.shiftKey||h(),f(!g),e.detail>1&&c(!0),!0)}),n.COMMAND_PRIORITY_LOW),o.registerCommand(n.KEY_DELETE_COMMAND,y,n.COMMAND_PRIORITY_LOW),o.registerCommand(n.KEY_BACKSPACE_COMMAND,y,n.COMMAND_PRIORITY_LOW))),[h,o,g,p,y,f]);const b=r.useCallback((()=>(c(!1),o.update((()=>{const e=n.$getNodeByKey(i);m(e)&&e.remove()})))),[o,i]),v=r.useMemo((()=>JSON.parse(l)),[l]);return r.createElement(r.Fragment,null,r.createElement(D,{initialElements:v,isShown:s,onDelete:b,onSave:e=>{o.setEditable(!0),(e=>{if(o.isEditable())o.update((()=>{const t=n.$getNodeByKey(i);m(t)&&(e.length>0?t.setData(JSON.stringify(e)):t.remove())}))})(e),c(!1)},closeOnClickOutside:!0}),v.length>0&&r.createElement("button",{ref:d,className:"excalidraw-button "+(g?"selected":"")},r.createElement(N,{imageContainerRef:u,className:"image",elements:v}),(g||p)&&r.createElement(_,{buttonRef:E,showCaption:!0,setShowCaption:()=>null,imageRef:u,editor:o,onResizeStart:()=>{w(!0)},onResizeEnd:()=>{setTimeout((()=>{w(!1)}),200)},captionsEnabled:!0})))}};exports.$createExcalidrawNode=d,exports.$isExcalidrawNode=m,exports.ExcalidrawNode=u,exports.ExcalidrawPlugin=g,exports.excalidrawExt=p;
